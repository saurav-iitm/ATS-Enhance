<!DOCTYPE html>
<html>
<head>
    <title>AI Resume Upgrade</title>
    <style>
        body {
            background:#050816;
            color:white;
            font-family:sans-serif;
            padding:30px;
        }
        textarea {
            width:100%;
            height:280px;
            background:#111;
            color:#eee;
            padding:12px;
            border-radius:10px;
            font-size:16px;
            line-height:1.45;
            white-space:pre-wrap;
        }
        button {
            background:#7c3aed;
            border:none;
            color:white;
            padding:14px 26px;
            border-radius:9px;
            cursor:pointer;
            font-size:18px;
            margin-top:14px;
            font-weight:600;
        }
        button:hover { transform:scale(1.07); }

        .scoreBox{
            padding:12px;
            margin:15px 0;
            background:#18181b;
            border-left:6px solid #a855f7;
            font-size:18px;
        }

        #status{
            font-size:20px;
            margin-top:15px;
            color:#22d3ee;
            font-weight:600;
        }

        a { color:#10b981; display:block; font-size:18px; margin-top:22px; }
    </style>
</head>

<body>

<h1>‚ö† Resume Needs Improvement</h1>
<p>Your resume score is below **90%**.  
Click the button below and my AI will keep improving until score ‚â• 90.</p>

<div class="scoreBox">
    üö® Starting Score: <b>{{ initial_score }} / 100</b>
</div>

<textarea id="resumeBox">{{ resume_text }}</textarea>

<button onclick="startImprove()">üöÄ Auto Improve to 90%+</button>

<p id="status"></p>

<form id="saveForm" action="/rewrite" method="POST" hidden>
    <textarea name="resume_text" id="saveResumeText"></textarea>
    <textarea name="job_description">{{ job_text }}</textarea>
</form>

<br><br>

<button onclick="downloadTxt()">‚¨á Download Improved Resume (.txt)</button>
<a href="/">‚¨Ö Back to Home</a>

<script>
async function startImprove(){

    let resume = document.getElementById("resumeBox").value;
    let job    = `{{ job_text | tojson }}`;

    let loops  = 0;
    let done   = false;

    document.getElementById("status").innerHTML="‚è≥ Improving..."

    while(!done && loops < 10){

        loops++;

        let res = await fetch("/improve_loop", {
            method:"POST",
            headers:{ "Content-Type":"application/x-www-form-urlencoded" },
            body:`resume_text=${encodeURIComponent(resume)}&job_text=${encodeURIComponent(job)}`
        });

        let data = await res.json();
        resume = data.resume;

        document.getElementById("resumeBox").value = resume;
        document.getElementById("status").innerHTML =
            `‚ö° Score now: ${data.score}/100 (pass ${loops})`;

        if (data.done){ done = true }
    }

    if(done){
        document.getElementById("status").innerHTML =
            "üéâ FINAL SCORE ABOVE 90%! Resume is ATS READY!";
    }
    else{
        document.getElementById("status").innerHTML =
            "‚ö† Could not reach 90%. Edit manually if needed.";
    }

    document.getElementById("saveResumeText").value = resume;
}

function downloadTxt(){
    let text = document.getElementById("resumeBox").value;
    let a = document.createElement("a");
    a.href="data:text/plain;charset=utf-8,"+ encodeURIComponent(text);
    a.download="AI_Improved_Resume.txt";
    a.click();
}
</script>

</body>
</html>
